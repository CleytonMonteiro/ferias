<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Férias com Firebase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        td input, td select {
            width: 95%;
            box-sizing: border-box;
        }
        .action-cell {
            text-align: center;
        }
        .action-btn {
            padding: 5px 10px;
            cursor: pointer;
            margin: 2px;
        }
        #add-row-btn {
            margin-top: 15px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .agendada-row {
            background-color: #ffe0b2; /* Laranja claro */
        }
        .retirada-row {
            background-color: #c8e6c9; /* Verde claro */
        }
        .em-preenchimento-row {
            background-color: #fffac8; /* Amarelo claro */
        }
        .filter-container {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Classe para esconder a coluna "Ações" no PDF */
        .hide-on-pdf {
            display: none;
        }
        /* Estilos para os novos contadores */
        .summary-container {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        .summary-item {
            font-size: 1.1em;
            font-weight: bold;
        }
        /* Novo estilo para o ano no título */
        #current-year {
            font-weight: bold;
            color: #0056b3; /* Azul escuro */
        }
    </style>
</head>
<body>

    <h2 id="page-title">Controle de Férias de Funcionários <span id="current-year"></span></h2>

    <div class="filter-container">
        <label for="status-filter">Filtrar por Status:</label>
        <select id="status-filter">
            <option value="todos">Todos</option>
            <option value="agendada">Agendada</option>
            <option value="retirada">Retirada</option>
            <option value="em preenchimento">Em preenchimento</option>
        </select>
    </div>

    <table id="vacation-table">
        <thead>
            <tr>
                <th>Nome</th>
                <th id="sort-by-start-date">Data Início</th>
                <th>Data Final</th>
                <th>Dias de Férias</th>
                <th>Status</th>
                <th class="action-cell">Ações</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
    
    <div class="summary-container">
        <div id="vacation-taken" class="summary-item"></div>
        <div id="vacation-pending" class="summary-item"></div>
    </div>
    
    <button id="add-row-btn">Adicionar Funcionário</button>
    <button id="generate-pdf-btn">Gerar PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // --- 1. CONFIGURAÇÕES DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3YXxXDbvvqxq1Mj5QKRPYW_5FM7EMrgQ",
            authDomain: "ferias-ed05b.firebaseapp.com",
            projectId: "ferias-ed05b",
            storageBucket: "ferias-ed05b.firebasestorage.app",
            messagingSenderId: "577132000120",
            appId: "1:577132000120:web:46a5c9aec76164a4c7ce8d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const tableBody = document.querySelector('#vacation-table tbody');
        const addRowBtn = document.getElementById('add-row-btn');
        const sortByStartDateBtn = document.getElementById('sort-by-start-date');
        const statusFilter = document.getElementById('status-filter');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        
        const vacationTakenDiv = document.getElementById('vacation-taken');
        const vacationPendingDiv = document.getElementById('vacation-pending');

        let isSorted = false;
        
        // --- Funções principais ---

        const calculateDays = (startDate, endDate) => {
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                return diffDays;
            }
            return 0;
        };
        
        const saveData = async (rowData, docId = null) => {
            try {
                if (docId) {
                    await db.collection('vacations').doc(docId).set(rowData);
                } else {
                    await db.collection('vacations').add(rowData);
                }
            } catch (error) {
                console.error("Erro ao salvar documento: ", error);
            }
        };

        const deleteData = async (docId) => {
            try {
                await db.collection('vacations').doc(docId).delete();
            } catch (error) {
                console.error("Erro ao deletar documento: ", error);
            }
        };

        const createRow = (employee = { name: '', startDate: '', endDate: '', status: 'em preenchimento' }, docId = null) => {
            const newRow = document.createElement('tr');
            newRow.dataset.docId = docId;
            newRow.innerHTML = `
                <td><input type="text" class="employee-name" value="${employee.name}" placeholder="Nome do Funcionário"></td>
                <td><input type="date" class="start-date" value="${employee.startDate}"></td>
                <td><input type="date" class="end-date" value="${employee.endDate}"></td>
                <td class="days-off-cell">${calculateDays(employee.startDate, employee.endDate)}</td>
                <td>
                    <select class="status-select">
                        <option value="em preenchimento" ${employee.status === 'em preenchimento' ? 'selected' : ''}>Em preenchimento</option>
                        <option value="agendada" ${employee.status === 'agendada' ? 'selected' : ''}>Agendada</option>
                        <option value="retirada" ${employee.status === 'retirada' ? 'selected' : ''}>Retirada</option>
                    </select>
                </td>
                <td class="action-cell"><button class="action-btn delete-btn">Excluir</button></td>
            `;

            addEventListenersToRow(newRow);
            if (employee.status === 'agendada') {
                newRow.classList.add('agendada-row');
            } else if (employee.status === 'retirada') {
                newRow.classList.add('retirada-row');
            } else {
                newRow.classList.add('em-preenchimento-row');
            }
            tableBody.appendChild(newRow);
        };
        
        const addEventListenersToRow = (row) => {
            const employeeNameInput = row.querySelector('.employee-name');
            const startDateInput = row.querySelector('.start-date');
            const endDateInput = row.querySelector('.end-date');
            const daysOffCell = row.querySelector('.days-off-cell');
            const deleteBtn = row.querySelector('.delete-btn');
            const statusSelect = row.querySelector('.status-select');
            const otherInputs = row.querySelectorAll('input:not(.employee-name)');

            employeeNameInput.addEventListener('blur', () => {
                employeeNameInput.value = employeeNameInput.value.toUpperCase();
                validateAndSave();
            });

            const validateAndSave = () => {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const statusValue = statusSelect.value;

                if (!startDate || !endDate) {
                    daysOffCell.textContent = 0;
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    alert("A data de início não pode ser depois da data de fim!");
                    startDateInput.value = '';
                    endDateInput.value = '';
                    daysOffCell.textContent = 0;
                    return;
                }

                const days = calculateDays(startDate, endDate);
                daysOffCell.textContent = days;

                const rowData = {
                    name: employeeNameInput.value,
                    startDate: startDate,
                    endDate: endDate,
                    status: statusValue
                };
                
                row.classList.remove('agendada-row', 'retirada-row', 'em-preenchimento-row');
                if (statusValue === 'agendada') {
                    row.classList.add('agendada-row');
                } else if (statusValue === 'retirada') {
                    row.classList.add('retirada-row');
                } else {
                    row.classList.add('em-preenchimento-row');
                }

                saveData(rowData, row.dataset.docId);
            };

            otherInputs.forEach(input => {
                input.addEventListener('change', validateAndSave);
                input.addEventListener('keyup', validateAndSave);
            });

            statusSelect.addEventListener('change', validateAndSave);

            deleteBtn.addEventListener('click', () => {
                deleteData(row.dataset.docId);
                row.remove();
            });
        };

        const loadData = (filterStatus = 'todos') => {
            db.collection('vacations').onSnapshot((querySnapshot) => {
                tableBody.innerHTML = '';
                
                let vacationTakenCount = 0;
                let vacationPendingCount = 0;
                let filteredData = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    if (data.status === 'retirada') {
                        vacationTakenCount++;
                    } else if (data.status === 'agendada' || data.status === 'em preenchimento') {
                        vacationPendingCount++;
                    }

                    if (filterStatus === 'todos' || data.status === filterStatus) {
                        filteredData.push({ data, id: doc.id });
                    }
                });

                filteredData.forEach(item => {
                    createRow(item.data, item.id);
                });

                vacationTakenDiv.textContent = `Tiraram férias: ${vacationTakenCount}`;
                vacationPendingDiv.textContent = `Faltam tirar férias: ${vacationPendingCount}`;

            }, (error) => {
                console.error("Erro ao carregar dados: ", error);
            });
        };

        sortByStartDateBtn.addEventListener('click', () => {
            loadData(statusFilter.value);
        });

        statusFilter.addEventListener('change', (e) => {
            loadData(e.target.value);
        });

        addRowBtn.addEventListener('click', () => {
            const newRowData = { name: '', startDate: '', endDate: '', status: 'em preenchimento' };
            saveData(newRowData);
        });

        generatePdfBtn.addEventListener('click', () => {
            const actionHeader = document.querySelector('th.action-cell');
            const actionCells = document.querySelectorAll('td.action-cell');
            
            actionHeader.classList.add('hide-on-pdf');
            actionCells.forEach(cell => cell.classList.add('hide-on-pdf'));

            const content = document.body;

            html2canvas(content).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');

                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save('Controle-de-Ferias.pdf');

                actionHeader.classList.remove('hide-on-pdf');
                actionCells.forEach(cell => cell.classList.remove('hide-on-pdf'));
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadData('todos');
            
            db.collection('vacations').get().then(snapshot => {
                if (snapshot.empty) {
                    createRow();
                }
            }).catch(error => {
                console.error("Erro ao verificar a coleção: ", error);
                createRow();
            });

            const currentYearSpan = document.getElementById('current-year');
            const currentYear = new Date().getFullYear();
            currentYearSpan.textContent = `(${currentYear})`;
        });
    </script>
</body>
</html>